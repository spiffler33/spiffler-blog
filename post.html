<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>post | spiffler</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <nav class="top-nav">
                <a href="https://spiffler.xyz" class="logo">~/spiffler</a>
                <div class="nav-links">
                    <a href="/">blog</a>
                    <a href="/write.html">write</a>
                </div>
            </nav>
        </header>

        <main>
            <article id="post-content">
                <p class="empty-state">loading...</p>
            </article>
        </main>

        <footer>
            <span>spiffler.xyz</span>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const REPO_OWNER = 'spiffler33';
        const REPO_NAME = 'spiffler-blog';
        let currentFilename = null;
        let currentSha = null;

        async function loadPost() {
            const container = document.getElementById('post-content');
            const params = new URLSearchParams(window.location.search);
            currentFilename = params.get('p');

            if (!currentFilename) {
                container.innerHTML = '<p class="empty-state">post not found</p>';
                return;
            }

            try {
                // Get file with sha for delete
                const metaRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/posts/${currentFilename}`);
                if (metaRes.ok) {
                    const meta = await metaRes.json();
                    currentSha = meta.sha;
                }

                const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/master/posts/${currentFilename}`);
                if (!res.ok) throw new Error('Not found');

                const content = await res.text();
                const { title, date, body } = parsePost(content);

                document.title = `${title} | spiffler`;

                const token = localStorage.getItem('github_token');
                const deleteBtn = token ? `<button class="delete-post-btn" onclick="deletePost()">delete post</button>` : '';

                container.innerHTML = `
                    <a href="/" class="back-link">‚Üê back</a>
                    <h1 class="post-title">${escapeHtml(title)}</h1>
                    <div class="post-meta">
                        <span class="post-date">${date}</span>
                        ${deleteBtn}
                    </div>
                    <div class="post-body">${marked.parse(body)}</div>
                `;

            } catch (err) {
                container.innerHTML = '<p class="empty-state">post not found</p>';
            }
        }

        async function deletePost() {
            if (!confirm('Delete this post?')) return;

            const token = localStorage.getItem('github_token');
            if (!token || !currentSha) {
                alert('Cannot delete');
                return;
            }

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/posts/${currentFilename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: 'Delete post',
                        sha: currentSha
                    })
                });

                if (res.ok) {
                    window.location.href = '/';
                } else {
                    alert('Failed to delete');
                }
            } catch (err) {
                alert('Failed to delete');
            }
        }

        function parsePost(content) {
            let title = 'untitled';
            let date = '';
            let body = content;

            const match = content.match(/^---\n([\s\S]*?)\n---\n*([\s\S]*)/);
            if (match) {
                const frontmatter = match[1];
                body = match[2];

                frontmatter.split('\n').forEach(line => {
                    const [key, ...rest] = line.split(':');
                    if (key && rest.length) {
                        const value = rest.join(':').trim();
                        if (key.trim() === 'title') title = value;
                        if (key.trim() === 'date') date = value;
                    }
                });
            }

            return { title, date, body };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadPost();
    </script>
</body>
</html>
