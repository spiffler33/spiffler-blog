<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog | spiffler.xyz</title>
    <meta name="description" content="Thoughts and writings from spiffler. Code, ideas, and things learned along the way.">

    <!-- Open Graph -->
    <meta property="og:title" content="Blog | spiffler.xyz">
    <meta property="og:description" content="Thoughts and writings from spiffler. Code, ideas, and things learned along the way.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blog.spiffler.xyz/">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Blog | spiffler.xyz">
    <meta name="twitter:description" content="Thoughts and writings from spiffler. Code, ideas, and things learned along the way.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <nav class="top-nav">
                <a href="https://spiffler.xyz" class="logo">~/spiffler</a>
                <div class="nav-links">
                    <a href="/">blog</a>
                    <a href="/write.html">write</a>
                    <div class="theme-switcher">
                        <button class="theme-btn" id="theme-toggle">theme</button>
                        <div class="theme-menu" id="theme-menu">
                            <button class="theme-option" data-theme="paper">paper</button>
                            <button class="theme-option" data-theme="dark">dark</button>
                            <button class="theme-option" data-theme="matrix">matrix</button>
                            <button class="theme-option" data-theme="midnight">midnight</button>
                            <button class="theme-option" data-theme="mono">mono</button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <main>
            <section class="posts-section">
                <div id="posts-list">
                    <p class="empty-state">loading...</p>
                </div>
            </section>
        </main>

        <footer>
            <span>spiffler.xyz</span>
        </footer>
    </div>

    <script>
        const REPO_OWNER = 'spiffler33';
        const REPO_NAME = 'spiffler-blog';

        async function loadPosts() {
            const container = document.getElementById('posts-list');

            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/posts`);
                if (!res.ok) throw new Error('No posts');

                const files = await res.json();
                const posts = files
                    .filter(f => f.name.endsWith('.md'))
                    .sort((a, b) => b.name.localeCompare(a.name));

                if (posts.length === 0) {
                    container.innerHTML = '<p class="empty-state">no posts yet</p>';
                    return;
                }

                const postData = await Promise.all(posts.map(async (p) => {
                    const contentRes = await fetch(p.download_url);
                    const content = await contentRes.text();
                    const { title, date } = parseFrontmatter(content);
                    return {
                        filename: p.name,
                        title: title || p.name.replace('.md', ''),
                        date: date || p.name.substring(0, 10)
                    };
                }));

                container.innerHTML = postData.map(p => `
                    <a href="/post.html?p=${encodeURIComponent(p.filename)}" class="post-link">
                        <span class="post-link-date">${p.date}</span>
                        <span class="post-link-title">${escapeHtml(p.title)}</span>
                    </a>
                `).join('');

            } catch (err) {
                container.innerHTML = '<p class="empty-state">no posts yet</p>';
            }
        }

        function parseFrontmatter(content) {
            const match = content.match(/^---\n([\s\S]*?)\n---/);
            if (!match) return {};

            const frontmatter = {};
            match[1].split('\n').forEach(line => {
                const [key, ...rest] = line.split(':');
                if (key && rest.length) {
                    frontmatter[key.trim()] = rest.join(':').trim();
                }
            });
            return frontmatter;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadPosts();
    </script>
    <script>
        // Theme switcher
        (function() {
            const themes = ['paper', 'dark', 'matrix', 'midnight', 'mono'];
            const toggle = document.getElementById('theme-toggle');
            const menu = document.getElementById('theme-menu');

            function setTheme(theme) {
                if (theme === 'paper') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', theme);
                }
                localStorage.setItem('theme', theme);
                updateActiveOption(theme);
            }

            function updateActiveOption(theme) {
                menu.querySelectorAll('.theme-option').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
            }

            // Load saved theme
            const saved = localStorage.getItem('theme') || 'paper';
            setTheme(saved);

            // Toggle menu
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('open');
            });

            // Theme selection
            menu.querySelectorAll('.theme-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    setTheme(btn.dataset.theme);
                    menu.classList.remove('open');
                });
            });

            // Close on outside click
            document.addEventListener('click', () => menu.classList.remove('open'));
        })();
    </script>
</body>
</html>
